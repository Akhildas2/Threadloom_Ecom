<%- include('../adminLayouts/header.ejs') %>
    <%- include('../adminLayouts/navbar.ejs') %>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">


        <section class="content-main">
            <div class="content-header">
                <h2 class="content-title card-title">Sales Report</h2>
                <div class="d-flex gap-3">
                    <% if (orders.length> 0) { %>
                        <button id="pdfDownloadBtn" class="btn btn-warning"
                            onclick="window.location.href='/admin/orderList/salesReport?format=pdf&startDate=<%= startDate %>&endDate=<%= endDate %>'">
                            <i class="fas fa-file-pdf"></i> PDF Report
                        </button>

                        <button id="excelDownloadBtn" class="btn btn-success"
                            onclick="window.location.href='/admin/orderList/salesReport?format=excel&startDate=<%= startDate %>&endDate=<%= endDate %>'">
                            <i class="fas fa-file-excel"></i> Excel Report
                        </button>
                        <% } %>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-uppercase text-muted small mb-1">Total Sales</h6>
                                    <h3 class="mb-0">
                                        <%= totalSalesCount %>
                                    </h3>
                                </div>
                                <i class="fas fa-shopping-cart fs-1 text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-uppercase text-muted small mb-1">Total Revenue</h6>
                                    <h3 class="mb-0">₹<%= totalSalesAmount.toFixed(2) %>
                                    </h3>
                                </div>
                                <i class="fas fa-rupee-sign fs-1 text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-uppercase text-muted small mb-1">Total Discount</h6>
                                    <h3 class="mb-0">₹<%= totalDiscountAmount.toFixed(2) %>
                                    </h3>
                                </div>
                                <i class="fas fa-percent fs-1 text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4 shadow-sm">
                <header class="card-header">
                    <div class="row g-3 align-items-center">
                        <div class="col-12 col-lg-9">
                            <form class="row g-2" action="/admin/orderList/salesReport" method="get">
                                <div class="col-12 col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text"><i
                                                class="material-icons md-calendar_today"></i></span>
                                        <input type="date" id="startDate" name="startDate" class="form-control"
                                            placeholder="Start Date">
                                    </div>
                                </div>
                                <div class="col-12 col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text"><i
                                                class="material-icons md-calendar_today"></i></span>
                                        <input type="date" id="endDate" name="endDate" class="form-control"
                                            placeholder="End Date">
                                    </div>
                                </div>
                                <div class="col-12 col-md-4">
                                    <select id="period" name="period" class="form-select">
                                        <option value="">All Periods</option>
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="yearly">Yearly</option>
                                        <option value="custom">Custom Range</option>
                                    </select>
                                </div>
                        </div>
                        <div class="col-12 col-lg-3 text-lg-end">
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" type="submit">
                                    <i class="material-icons md-filter_list me-1"></i> Apply Filters
                                </button>
                            </div>
                        </div>
                        </form>
                    </div>
                </header>
                <header class="card-header">
                    <div class="row g-2 align-items-center">
                        <!-- Search Form Column -->
                        <div class="col-12 col-md-9 col-lg-9">
                            <form
                                class="d-flex flex-column flex-sm-row gap-2 align-items-stretch justify-content-center"
                                action="/admin/orderList/salesReport" method="get">

                                <!-- Search Input -->
                                <div class="flex-grow-1">
                                    <input type="text" class="form-control w-100 mb-0" id="searchInput" name="search"
                                        value="<%= search || '' %>" placeholder="Search order">
                                </div>

                                <!-- Status Select -->
                                <div class="flex-grow-1 flex-sm-grow-0">
                                    <select name="status" class="form-select w-100">
                                        <option value="">All</option>
                                        <% const statuses=['cod', 'wallet' , 'paypal' , 'credit-card' ]; %>
                                            <% statuses.forEach(st=> { %>
                                                <option value="<%= st %>" <%=orderStatus===st ? 'selected' : '' %>><%=
                                                        st %>
                                                </option>
                                                <% }) %>
                                    </select>
                                </div>

                                <!-- Submit Button -->
                                <div>
                                    <button class="btn btn-light w-100" type="submit">
                                        <i class="material-icons md-search"></i>
                                        <span class="d-none d-sm-inline">Search</span>
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Limit Select Column -->
                        <div class="col-12 col-md-3 col-lg-3">
                            <div class="d-flex justify-content-center justify-content-md-end">
                                <select id="orderLimit" class="form-select w-auto" onchange="location = this.value;">
                                    <% const limits=[1,5, 10, 20, 50, 100]; %>
                                        <% limits.forEach(lim=> { %>
                                            <option
                                                value="?page=1&limit=<%= lim %>&search=<%= search %>&orderStatus=<%= orderStatus %>&sort=<%= sortField %>&order=<%= sortOrder %>"
                                                <%=limit==lim ? 'selected' : '' %>>Show <%= lim %>
                                            </option>
                                            <% }) %>
                                </select>
                            </div>
                        </div>
                    </div>
                </header>

                <% if (orders.length> 0) { %>
                    <div class="card mb-0 shadow-sm border-0 rounded-lg">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th class="text-center py-3 border-0">No</th>
                                            <th class="py-3 border-0">
                                                <a href="?sort=ordersId&order=<%= sortField === 'ordersId' ? (sortOrder === 'asc' ? 'desc' : 'asc') : 'asc' %>"
                                                    class="text-reset text-decoration-none d-inline-flex align-items-center">
                                                    Order ID
                                                    <% if (sortField==='ordersId' ) { %>
                                                        <i
                                                            class="fas fa-sort-<%= sortOrder === 'asc' ? 'up' : 'down' %> ms-2"></i>
                                                        <% } else { %>
                                                            <i class="fas fa-sort ms-2 text-muted"></i>
                                                            <% } %>
                                                </a>
                                            </th>

                                            <th class="py-3 border-0">
                                                <a href="?sort=expectedDelivery&order=<%= sortField === 'expectedDelivery' ? (sortOrder === 'asc' ? 'desc' : 'asc') : 'asc' %>"
                                                    class="text-reset text-decoration-none d-inline-flex align-items-center">
                                                    Delivery Date
                                                    <% if (sortField==='expectedDelivery' ) { %>
                                                        <i
                                                            class="fas fa-sort-<%= sortOrder === 'asc' ? 'up' : 'down' %> ms-2"></i>
                                                        <% } else { %>
                                                            <i class="fas fa-sort ms-2 text-muted"></i>
                                                            <% } %>
                                                </a>
                                            </th>
                                            <th class="text-center py-3 border-0">
                                                <a href="?sort=customer&order=<%= sortField === 'customer' ? (sortOrder === 'asc' ? 'desc' : 'asc') : 'asc' %>"
                                                    class="text-reset text-decoration-none d-inline-flex align-items-center">
                                                    Customer
                                                    <% if (sortField==='customer' ) { %>
                                                        <i
                                                            class="fas fa-sort-<%= sortOrder === 'asc' ? 'up' : 'down' %> ms-2"></i>
                                                        <% } else { %>
                                                            <i class="fas fa-sort ms-2 text-muted"></i>
                                                            <% } %>
                                                </a>
                                            </th>
                                            <th class="text-center py-3 border-0">Product</th>
                                            <th class="text-right py-3 border-0">Price</th>
                                            <th class="text-right py-3 border-0">Discount</th>
                                            <th class="py-3 border-0">
                                                <a href="?sort=paymentMethod&order=<%= sortField === 'paymentMethod' ? (sortOrder === 'asc' ? 'desc' : 'asc') : 'asc' %>"
                                                    class="text-reset text-decoration-none d-inline-flex align-items-center">
                                                    Payment
                                                    <% if (sortField==='paymentMethod' ) { %>
                                                        <i
                                                            class="fas fa-sort-<%= sortOrder === 'asc' ? 'up' : 'down' %> ms-2"></i>
                                                        <% } else { %>
                                                            <i class="fas fa-sort ms-2 text-muted"></i>
                                                            <% } %>
                                                </a>
                                            </th>
                                            <th class="text-right py-3 border-0">
                                                <a href="?sort=totalAmount&order=<%= sortField === 'totalAmount' ? (sortOrder === 'asc' ? 'desc' : 'asc') : 'asc' %>"
                                                    class="text-reset text-decoration-none d-inline-flex align-items-center">
                                                    Total
                                                    <% if (sortField==='totalAmount' ) { %>
                                                        <i
                                                            class="fas fa-sort-<%= sortOrder === 'asc' ? 'up' : 'down' %> ms-2"></i>
                                                        <% } else { %>
                                                            <i class="fas fa-sort ms-2 text-muted"></i>
                                                            <% } %>
                                                </a>
                                            </th>
                                        </tr>


                                    </thead>
                                    <tbody>
                                        <% let index=1; %>
                                            <% orders.forEach(order=> { %>
                                                <% let isFirstProduct=true; %>
                                                    <% order.items.forEach((item)=> { %>
                                                        <tr
                                                            class="position-relative <%= item === order.items[order.items.length - 1] ? 'border-bottom' : '' %>">
                                                            <% if (isFirstProduct) { %>
                                                                <td class="text-center align-middle"
                                                                    rowspan="<%= order.items.length %>">
                                                                    <span class="badge badge-light">
                                                                        <%= index %>
                                                                    </span>
                                                                </td>
                                                                <td class="align-middle"
                                                                    rowspan="<%= order.items.length %>">
                                                                    <%= order.ordersId %>
                                                                </td>
                                                                <td class="align-middle"
                                                                    rowspan="<%= order.items.length %>">
                                                                    <span class="text-nowrap">
                                                                        <%= new
                                                                            Date(order.expectedDelivery).toLocaleDateString('en-IN',
                                                                            { day: '2-digit' , month: 'short' ,
                                                                            year: 'numeric' }) %>
                                                                    </span>
                                                                </td>
                                                                <td class="align-middle"
                                                                    rowspan="<%= order.items.length %>">
                                                                    <div
                                                                        class="d-flex align-items-center justify-content-center">
                                                                        <div class="ml-2">
                                                                            <div>
                                                                                <%=
                                                                                    order.deliveryAddress.fullName.length>
                                                                                    10
                                                                                    ?
                                                                                    order.deliveryAddress.fullName.slice(0,15)
                                                                                    + '...' :
                                                                                    order.deliveryAddress.fullName
                                                                                    %>
                                                                            </div>
                                                                            <small class="text-muted">
                                                                                <%= order.deliveryAddress.city &&
                                                                                    order.deliveryAddress.city.length>
                                                                                    15
                                                                                    ?
                                                                                    order.deliveryAddress.city.slice(0,
                                                                                    15) + '...'
                                                                                    : order.deliveryAddress.city %>

                                                                            </small>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <% } %>
                                                                    <td class="align-middle">
                                                                        <div
                                                                            class="d-flex align-items-center justify-content-center text-center">
                                                                            <img src="/uploads/product/resized/<%= item.productId.productImage[0] %>"
                                                                                class="img-thumbnail border rounded"
                                                                                style="width: 60px; height: 60px; object-fit: cover;">
                                                                            <div class="ms-2">
                                                                                <div>
                                                                                    <%= item.productId.name.length> 20
                                                                                        ? item.productId.name.slice(0,
                                                                                        20) + '...'
                                                                                        : item.productId.name %>

                                                                                </div>
                                                                                <small class="text-muted">Quantity: <%=
                                                                                        item.quantity %></small>
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                    <td class="text-right align-middle">₹<%=
                                                                            item.price.toLocaleString('en-IN') %>
                                                                    </td>
                                                                    <% if (isFirstProduct) { %>
                                                                        <td class="text-right align-middle text-success"
                                                                            rowspan="<%= order.items.length %>">
                                                                            <% let fullDiscount=(order.offerDiscount ||
                                                                                0) + (order.couponDiscount || 0) %>
                                                                                <% if(fullDiscount> 0) { %>
                                                                                    -₹<%=
                                                                                        fullDiscount.toLocaleString('en-IN')
                                                                                        %>
                                                                                        <% } else { %>
                                                                                            <span
                                                                                                class="text-muted">0</span>
                                                                                            <% } %>
                                                                        </td>
                                                                        <td class="align-middle"
                                                                            rowspan="<%= order.items.length %>">
                                                                            <span
                                                                                class="badge bg-light text-white border">
                                                                                <% if (order.paymentMethod==='cod' ) {
                                                                                    %>
                                                                                    <i
                                                                                        class="fas fa-credit-card text-primary me-2"></i>
                                                                                    <% } else if
                                                                                        (order.paymentMethod==='paypal'
                                                                                        ) { %>
                                                                                        <i
                                                                                            class="fab fa-paypal text-info me-2"></i>
                                                                                        <% } else { %>
                                                                                            <i
                                                                                                class="fas fa-wallet text-success me-2"></i>
                                                                                            <% } %>
                                                                                                <%= order.paymentMethod
                                                                                                    %>
                                                                            </span>

                                                                        </td>
                                                                        <td class="text-right align-middle font-weight-bold"
                                                                            rowspan="<%= order.items.length %>">
                                                                            ₹<%= order.totalAmount.toLocaleString('en-IN')
                                                                                %>
                                                                        </td>
                                                                        <% } %>

                                                        </tr>

                                                        <% isFirstProduct=false; %>
                                                            <% }) %>
                                                                <% index++; %>
                                                                    <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <% } else { %>
                        <div class="empty-state text-center py-5">
                            <div class="empty-state-icon">
                                <i class="fas fa-shopping-cart fa-3x text-muted"></i>
                            </div>
                            <h3 class="mt-3">No Orders Found</h3>
                            <p class="text-muted">Your order list is currently empty.</p>
                        </div>
                        <% } %>


            </div>

            <!-- Pagination -->
            <div class="pagination-area mt-30 mb-50">
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-end">
                        <% if (currentPage> 1) { %>
                            <li class="page-item">
                                <a class="page-link"
                                    href="?page=<%= currentPage - 1 %>&limit=<%= limit %>&startDate=<%= startDate %>&endDate=<%= endDate %>&period=<%= period %>&status=<%= orderStatus %>&search=<%= search %>&sort=<%= sortField %>&order=<%= sortOrder %>">
                                    <i class="material-icons md-chevron_left"></i>
                                </a>
                            </li>
                            <% } %>
                                <% for (let i=1; i <=totalPages; i++) { %>
                                    <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                        <a class="page-link"
                                            href="?page=<%= i %>&limit=<%= limit %>&startDate=<%= startDate %>&endDate=<%= endDate %>&period=<%= period %>&status=<%= orderStatus %>&search=<%= search %>&sort=<%= sortField %>&order=<%= sortOrder %>">
                                            <%= i %>
                                        </a>
                                    </li>
                                    <% } %>
                                        <% if (currentPage < totalPages) { %>
                                            <li class="page-item">
                                                <a class="page-link"
                                                    href="?page=<%= currentPage + 1 %>&limit=<%= limit %>&startDate=<%= startDate %>&endDate=<%= endDate %>&period=<%= period %>&status=<%= orderStatus %>&search=<%= search %>&sort=<%= sortField %>&order=<%= sortOrder %>">
                                                    <i class="material-icons md-chevron_right"></i>
                                                </a>
                                            </li>
                                            <% } %>
                    </ul>
                </nav>
            </div>
        </section>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

        <script>

            document.addEventListener("DOMContentLoaded", function () {
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                const periodSelect = document.getElementById('period');

                startDateInput.addEventListener('change', updatePeriodBasedOnDates);
                endDateInput.addEventListener('change', updatePeriodBasedOnDates);
                periodSelect.addEventListener('change', resetDateRange);

                function updatePeriodBasedOnDates() {
                    const startDate = new Date(startDateInput.value);
                    const endDate = new Date(endDateInput.value);
                    const diffDays = calculateDiffInDays(startDate, endDate);

                    periodSelect.value = getPeriodBasedOnDays(diffDays);
                }

                function resetDateRange() {
                    startDateInput.value = '';
                    endDateInput.value = '';
                }

                function calculateDiffInDays(dateFrom, dateTo) {
                    const diffTime = Math.abs(dateTo - dateFrom);
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                }

                function getPeriodBasedOnDays(days) {
                    if (days === 0) return 'daily';
                    if (days === 7) return 'weekly';
                    if (days === 31) return 'monthly';
                    if (days === 365) return 'yearly';
                    return 'custom';
                }
            });


        </script>
        <%- include('../adminLayouts/footer.ejs') %>