<%- include('../layouts/header.ejs', {address: address, cartItems: cartItems}) %>
    <%- include('../layouts/navbar.ejs', {address: address, cartItems: cartItems}) %>

        <main class="main">
            <div class="page-header breadcrumb-wrap">
                <div class="container">
                    <div class="breadcrumb">
                        <a href="/" rel="nofollow">Home</a>
                        <span></span> Checkout
                    </div>
                </div>
            </div>
            <section class="mt-50 mb-50">
                <div class="container">
                    <!-- <div class="row">
                <div class="col-lg-6 mb-sm-15">
                    <div class="toggle_info">
                        <span><i class="fi-rs-user mr-10"></i><span class="text-muted">Already have an account?</span> <a href="#loginform" data-bs-toggle="collapse" class="collapsed" aria-expanded="false">Click here to login</a></span>
                    </div>
                    <div class="panel-collapse collapse login_form" id="loginform">
                        <div class="panel-body">
                            <p class="mb-30 font-sm">If you have shopped with us before, please enter your details below. If you are a new customer, please proceed to the Billing &amp; Shipping section.</p>
                            <form method="post">
                                <div class="form-group">
                                    <input type="text" name="email" placeholder="Username Or Email">
                                </div>
                                <div class="form-group">
                                    <input type="password" name="password" placeholder="Password">
                                </div>
                                <div class="login_footer form-group">
                                    <div class="chek-form">
                                        <div class="custome-checkbox">
                                            <input class="form-check-input" type="checkbox" name="checkbox" id="remember" value="">
                                            <label class="form-check-label" for="remember"><span>Remember me</span></label>
                                        </div>
                                    </div>
                                    <a href="#">Forgot password?</a>
                                </div>
                                <div class="form-group">
                                    <button class="btn btn-md" name="login">Log in</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="toggle_info">
                        <span><i class="fi-rs-label mr-10"></i><span class="text-muted">Have a coupon?</span> <a href="#coupon" data-bs-toggle="collapse" class="collapsed" aria-expanded="false">Click here to enter your code</a></span>
                    </div>
                    <div class="panel-collapse collapse coupon_form " id="coupon">
                        <div class="panel-body">
                            <p class="mb-30 font-sm">If you have a coupon code, please apply it below.</p>
                            <form method="post">
                                <div class="form-group">
                                    <input type="text" placeholder="Enter Coupon Code...">
                                </div>
                                <div class="form-group">
                                    <button class="btn  btn-md" name="login">Apply Coupon</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div> -->
                    <div class="row">
                        <div class="col-12">
                            <div class="divider mt-50 mb-50"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-25">
                                <h4>Billing Details</h4>
                            </div>
                            <div class="ship_detail">
                                <div class="form-group">
                                    <div class="chek-form">
                                        <div class="custome-checkbox">
                                            <input class="form-check-input" type="checkbox" name="checkbox"
                                                id="differentaddress" checked>
                                            <label class="form-check-label label_info" data-bs-toggle="collapse"
                                                data-target="#collapseAddress" href="#collapseAddress"
                                                aria-controls="collapseAddress" for="differentaddress"><span>Shipping
                                                    Address</span></label>
                                        </div>
                                    </div>
                                </div>
                                <div id="collapseAddress" class="different_address collapse in">
                                    <div class="form-group">
                                        <a href="#" class="btn-md btn-primary" id="addAddressModalBtn"
                                            data-toggle="modal" data-target="#addAddressModal">Add Address</a>
                                        <br>
                                        <br>
                                        <label for="savedAddresses">Select Address:</label>

                                        <% address.forEach((address, index)=> { %>
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-9">
                                                            <div class="custome-radio">
                                                                <input class="form-check-input" type="radio"
                                                                    name="shippingAddress" id="address_<%= index %>"
                                                                    value="<%= address._id %>" <% if (index===0) {
                                                                    %>checked<% } %>>
                                                                    <label class="form-check-label label_info"
                                                                        for="address_<%= index %>">
                                                                        <span>
                                                                            <%= address.fullName %>, <%= address.houseNo
                                                                                    %>, <%= address.area %>,
                                                                                        <%= address.city %>, <%=
                                                                                                address.state %> - <%=
                                                                                                    address.pincode %>
                                                                        </span>
                                                                    </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <% }); %>
                                    </div>
                                </div>
                                <!-- Add Address Modal -->
                                <div class="modal fade" id="addAddressModal" tabindex="-1" role="dialog"
                                    aria-labelledby="addAddressModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="addAddressModalLabel">Add Address</h5>
                                                <button type="button" class="close" data-dismiss="modal"
                                                    aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>

                                            </div>
                                            <div class="modal-body">
                                                <form id="addAddressForm">
                                                    <div class="form-group">
                                                        <label for="fullName">Full Name:</label>
                                                        <input type="text" id="fullName" name="fullName">
                                                        <span class="error" id="fullNameError"></span>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="mobileNumber">Mobile Number:</label>
                                                        <input type="text" id="mobileNumber" name="mobileNumber">
                                                        <span class="error" id="mobileNumberError"></span>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="pincode">Pincode:</label>
                                                        <input type="text" id="pincode" name="pincode">
                                                        <span class="error" id="pincodeError"></span>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="houseNo">House No,Name:</label>
                                                        <input type="text" id="houseNo" name="houseNo">
                                                        <span class="error" id="houseNoError"></span>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="area">Area,Street,Village</label>
                                                        <input type="text" id="area" name="area">
                                                        <span class="error" id="areaError"></span>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="city">City:</label>
                                                        <input type="text" id="city" name="city">
                                                        <span class="error" id="cityError"></span>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="state">State:</label>
                                                        <input type="text" id="state" name="state">
                                                        <span class="error" id="stateError"></span>
                                                    </div>
                                                    <button type="submit" class="btn btn-primary" id="addAddress">Add
                                                        Address</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>



                        <div class="col-md-6">
                            <div class="order_review">
                                <div class="mb-20">
                                    <h4>Your Orders</h4>
                                </div>
                                <div class="table-responsive order_table text-center">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th colspan="2">Product</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody data-cart-items="<%= JSON.stringify(cartItems) %>"
                                            data-total-price="<%= totalPrice %>">
                                            <% cartItems.forEach(item=> { %>
                                                <tr>
                                                    <td class="image product-thumbnail">
                                                        <img src="/uploads/product/resized/<%=item.productId.productImage[0] %>"
                                                            alt="<%= item.productId.name %>">

                                                    <td>
                                                        <h5 class="product-name"><a href="#">
                                                                <%= item.productId.name %>
                                                            </a></h5> (<%= item.price %>) <span class="product-qty"> *
                                                                <%= item.quantity %>
                                                            </span>
                                                    </td>
                                                    <td>₹<%= item.subtotal %>
                                                    </td>
                                                </tr>
                                                <% }); %>
                                                    <th>SubTotal</th>
                                                    <td class="product-subtotal" colspan="2">₹<%= totalPrice %>
                                                    </td>
                                                    </tr>
                                                    <tr>
                                                        <th>Shipping</th>
                                                        <td colspan="2"><em>Free Shipping</em></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Total</th>
                                                        <td colspan="2" class="product-subtotal"><span
                                                                class="font-xl text-brand fw-900">₹<%= totalPrice %>
                                                            </span></td>
                                                    </tr>

                                        </tbody>
                                    </table>
                                </div>
                                <div class="bt-1 border-color-1 mt-30 mb-30"></div>

                                <div class="payment_method">
                                    <div class="mb-25">
                                        <h5>Payment</h5>
                                    </div>
                                    <form id="checkoutForm">
                                        <input type="hidden" id="paymentMethod" name="paymentMethod" value="">
                                        <div class="payment_option">

                                            <div class="custome-radio">
                                                <input class="form-check-input" required="" type="radio"
                                                    name="paymentMethod" id="cod" checked="" value="cod">
                                                <label class="form-check-label" for="cod">Cash on delivery</label>

                                            </div>
                                            <div class="custome-radio">
                                                <input class="form-check-input" required="" type="radio"
                                                    name="paymentMethod" id="paypal" value="paypal">
                                                <label class="form-check-label" for="paypal">Paypal</label>

                                            </div>
                                        </div>
                                </div>
                                </form>
                                <a href="#" id="placeOrderBtn" class="btn btn-fill-out btn-block mt-30">Place Order</a>

                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>



        <%- include('../layouts/footer.ejs') %>
            <%- include('../layouts/preloader.ejs') %>
                <%- include('../layouts/script.ejs') %>

                    <!-- Include jQuery first -->
                    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                    <!-- Then include Bootstrap's JavaScript -->
                    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

                    <!-- Make sure to include Axios -->
                    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

                    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>




                    <script>



                        document.addEventListener('DOMContentLoaded', function () {
                            $(document).ready(function () {
                                $('#addAddressModalBtn').click(function () {
                                    $('#addAddressModal').modal('show');
                                });

                                $('.close').click(function () {
                                    $('#addAddressModal').modal('hide');
                                });
                            });
                            $(document).ready(function () {
                                $('#addAddressForm').submit(function (event) {
                                    event.preventDefault();
                                    // Reset error messages
                                    $('.error').text('');

                                    // Validation
                                    const fullName = $('#fullName').val().trim();
                                    const mobileNumber = $('#mobileNumber').val().trim();
                                    const pincode = $('#pincode').val().trim();
                                    const houseNo = $('#houseNo').val().trim();
                                    const area = $('#area').val().trim();
                                    const city = $('#city').val().trim();
                                    const state = $('#state').val().trim();
                                    let isValid = true;

                                    if (fullName === '') {
                                        $('#fullNameError').text('Please enter your full name.');
                                        isValid = false;
                                    }
                                    if (mobileNumber === '' || !/^\d{10}$/.test(mobileNumber)) {
                                        $('#mobileNumberError').text('Please enter a valid 10-digit mobile number.');
                                        isValid = false;
                                    }
                                    if (pincode === '' || !/^\d{6}$/.test(pincode)) {
                                        $('#pincodeError').text('Please enter a valid 6-digit pincode.');
                                        isValid = false;
                                    }
                                    if (houseNo === '') {
                                        $('#houseNoError').text('Please enter your house number/name.');
                                        isValid = false;
                                    }
                                    if (area === '') {
                                        $('#areaError').text('Please enter your area/street/village.');
                                        isValid = false;
                                    }
                                    if (city === '') {
                                        $('#cityError').text('Please enter your city.');
                                        isValid = false;
                                    }
                                    if (state === '') {
                                        $('#stateError').text('Please enter your state.');
                                        isValid = false;
                                    }
                                    if (!isValid) {
                                        return;
                                    }
                                    const formData = new FormData(this);

                                    axios.post('/addAddress', Object.fromEntries(formData))
                                        .then(response => {
                                            if (response.data.status) {
                                                Swal.fire({
                                                    icon: "success",
                                                    title: "Address add successfully!",
                                                    showConfirmButton: false,
                                                    timer: 2000
                                                });
                                                setTimeout(() => {
                                                    location.reload();
                                                }, 2000);
                                            } else {
                                                console.error(response.data);
                                            }
                                        })
                                        .catch(err => {
                                            console.error('Error:', err);
                                            if (!err.response.data.success) {
                                                Swal.fire({
                                                    icon: 'error',
                                                    title: 'Error',
                                                    text: err.response.data.message,
                                                });
                                            } else {
                                                console.error(err);
                                            }
                                        });
                                });
                            });
                            let selectedPaymentMethod = 'cod';
                            const placeOrderBtn = document.getElementById('placeOrderBtn');
                            let isSubmitting = false;
                            const body = document.querySelector('tbody');
                            const cartItems = JSON.parse(body.getAttribute('data-cart-items'));
                            const totalPrice = body.getAttribute('data-total-price');
                            const addressRadios = document.querySelectorAll('input[name="shippingAddress"]');


                            document.querySelectorAll('input[name="paymentMethod"]').forEach(input => {
                                input.addEventListener('change', function () {
                                    selectedPaymentMethod = this.value;
                                });
                            });
                            function updateSelectedAddressId() {
                                addressRadios.forEach(radio => {
                                    if (radio.checked) {
                                        selectedAddressId = radio.value;
                                    }
                                });
                            }

                            updateSelectedAddressId();

                            // Function to check if cartItems is empty
                            function isCartEmpty() {
                                return cartItems.length === 0;
                            }

                            // Function to check if no address is selected
                            function isAddressNotSelected() {
                                return !selectedAddressId;
                            }
                            // Function to update the "Place Order" button based on conditions
                            function updatePlaceOrderBtn() {
                                if (isCartEmpty() || isAddressNotSelected()) {
                                    placeOrderBtn.disabled = true;
                                    placeOrderBtn.textContent = 'Please add a product and select an address.';
                                } else {
                                    placeOrderBtn.disabled = false;
                                    placeOrderBtn.textContent = 'Place Order';
                                }
                            }

                            // Initial check
                            updatePlaceOrderBtn();

                            // Listen for changes in the radio buttons for addresses
                            addressRadios.forEach(radio => {
                                radio.addEventListener('change', function () {
                                    updateSelectedAddressId();
                                    updatePlaceOrderBtn();
                                });
                            });

                            placeOrderBtn.addEventListener('click', async function (event) {
                                event.preventDefault();
                                if (isCartEmpty() || isAddressNotSelected()) {
                                    Swal.fire({
                                        icon: 'warning',
                                        title: 'Oops...',
                                        text: 'Please add a product or select an address before placing your order.',
                                        confirmButtonText: 'Okay'
                                    });
                                    return;
                                }
                                if (isSubmitting) {
                                    return;
                                }
                                placeOrderBtn.disabled = true;
                                isSubmitting = true;
                                await new Promise(resolve => setTimeout(resolve, 10000));

                                placeOrderBtn.disabled = false;
                                isSubmitting = false;
                                axios.post('/order/placeOrder', {
                                    items: cartItems,
                                    total: totalPrice,
                                    addressId: selectedAddressId,
                                    paymentMethod: selectedPaymentMethod
                                })
                                    .then(response => {
                                        if (selectedPaymentMethod === 'paypal') {
                                            // Redirect to the PayPal approval URL for PayPal payments
                                            // console.log("hi it entered paypal", response.data.approvalUrl)
                                            if (response.data.approvalUrl) {
                                                window.location.href = response.data.approvalUrl;
                                            } else {
                                                Swal.fire({
                                                    icon: 'error',
                                                    title: 'Oops...',
                                                    text: 'PayPal payment initiation failed. Please try again.',
                                                    confirmButtonText: 'Okay'
                                                });
                                            }
                                        } else {
                                            console.log("response",response)
                                            if (response.data.successs)
                                                Swal.fire({
                                                    icon: 'success',
                                                    title: 'Order Placed!',
                                                    text: data.message,
                                                    confirmButtonText: 'Okay'
                                                });
                                            setTimeout(() => {
                                                const orderConfirmationUrl = `/order/orderConfirmation/${response.data.orderId}`;

                                                window.location.href = orderConfirmationUrl;
                                            }, 2000);
                                        }
                                    })
                                    .catch(error => {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'Oops...',
                                            text: 'Something went wrong! Please try again.',
                                            confirmButtonText: 'Okay'
                                        });
                                        console.error('Error placing order:', error);
                                    });
                            });
                        });
                    </script>